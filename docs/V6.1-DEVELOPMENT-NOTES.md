# StakeVue V6.1 - Development Notes

## Overview

This document records the development work done on V6.1 which aimed to enable **real CSPR transfers** between user wallets and the contract.

---

## V6.1 Contract (Deployed to Testnet)

```
Contract Hash: hash-d59ba3b52cbf5678f4a3e926e40758316b1119abd3cf8dbdd07300f601e42499
Package Hash: da7ec3951ab01e272bd340cbd69344814755da63f0b60016f56ebd90ae10e82a
Network: casper-test
Status: Deployed but NOT integrated in frontend
```

---

## What Was Built

### Smart Contract Changes

The V6.1 contract modified the stake/unstake functions to accept the user's purse as a parameter:

```rust
// V6.0 (current) - Internal tracking only
pub extern "C" fn stake() {
    let amount: U512 = runtime::get_named_arg("amount");
    // Only updates internal counters, no real CSPR transfer
}

// V6.1 (developed) - Real CSPR transfers
pub extern "C" fn stake() {
    let amount: U512 = runtime::get_named_arg("amount");
    let source_purse: URef = runtime::get_named_arg("source_purse");

    // Real transfer from user's purse to contract
    system::transfer_from_purse_to_purse(source_purse, contract_purse, amount, None)
        .unwrap_or_revert();
}
```

### Why Purse as Parameter?

The Casper VM **prevents contracts from accessing user purses** directly via `account::get_main_purse()`.

**The Problem:**
```rust
// This causes "Forged reference" error
let user_purse = account::get_main_purse(); // Contract can't access this!
```

**The Solution:**
Pass the purse as a parameter. When the user signs the transaction, the contract gains temporary access rights to the purse.

---

## Blocker: CORS Restrictions

To use V6.1, the frontend needs to:
1. Fetch the user's account info from Casper RPC
2. Extract the main purse URef
3. Pass it to the stake/unstake transaction

**Problem:** Browser CORS restrictions block direct calls to `https://rpc.testnet.casperlabs.io/rpc`

### Attempted Solutions (All Failed)

| Solution | Result |
|----------|--------|
| Direct RPC call | Blocked by CORS |
| Vercel Serverless Function (`/api/account.js`) | Runtime configuration errors |
| corsproxy.io | 530 error |
| allorigins.win | Failed |
| cors-anywhere | Failed |
| thingproxy | Failed |
| CSPR.cloud API | CORS issues |

---

## Current State

The project uses **V6.0** (internal tracking only):

| Feature | V6.0 (Current) | V6.1 (Developed) |
|---------|----------------|------------------|
| Stake tracking | Internal counter | Real CSPR transfer |
| stCSPR tokens | Minted internally | Minted on real deposit |
| User balance change | No | Yes |
| Contract balance | No | Yes |

**V6.0 works for demonstration/POC purposes** - users can see the staking flow, receive stCSPR tokens, and understand liquid staking concepts.

---

## Future Solutions

To enable V6.1 in the future:

### 1. Backend Proxy Server
Deploy a Node.js/Express server to proxy RPC calls:
```javascript
app.post('/api/account', async (req, res) => {
    const response = await fetch('https://rpc.testnet.casperlabs.io/rpc', {
        method: 'POST',
        body: JSON.stringify(req.body)
    });
    res.json(await response.json());
});
```

### 2. CSPR.click Native Support
If CSPR.click adds a method to get user's main purse directly, the frontend could use it without RPC calls.

### 3. Session Code Deployment
Deploy WASM that runs in user context (more complex architecture).

---

## Files Modified for V6.1

| File | Changes |
|------|---------|
| `smart-contract/src/lib.rs` | Added `source_purse` and `dest_purse` parameters |
| `client/src/services/transaction.ts` | Added `fetchMainPurse()` function |
| `client/api/account.js` | Vercel serverless function (attempted) |

---

## Conclusion

**V6.1 contract works correctly on testnet.** The limitation is purely a frontend/browser CORS restriction that requires a backend proxy to solve.

The contract hash is preserved here for future reference when a backend solution is implemented.

---

**Date:** December 2024
**Status:** Archived - Awaiting backend proxy solution
