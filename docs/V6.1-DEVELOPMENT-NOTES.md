# StakeVue V6.1 - Real CSPR Transfers

## Overview

V6.1 enables **real CSPR transfers** between user wallets and the contract. When users stake, their CSPR is transferred to the contract's purse. When they unstake, CSPR is transferred back to their wallet.

---

## Contract Architecture

### How It Works

```
STAKE:
User Wallet (CSPR) → Contract Purse → User gets stCSPR tokens

UNSTAKE:
User burns stCSPR → Contract Purse → User Wallet (CSPR returned)
```

### Key Components

| Component | Description |
|-----------|-------------|
| `contract_purse` | URef holding all staked CSPR |
| `source_purse` | User's purse for stake transfers |
| `dest_purse` | User's purse for unstake transfers |

---

## Entry Points

### stake(amount: U512, source_purse: Option<URef>)

Stakes CSPR and mints stCSPR tokens.

| Parameter | Type | Description |
|-----------|------|-------------|
| `amount` | U512 | Amount in motes to stake |
| `source_purse` | Option<URef> | User's purse for real transfer (optional) |

**Behavior:**
- If `source_purse` is `Some(purse)`: Real CSPR transferred from user to contract
- If `source_purse` is `None`: Demo mode (internal tracking only)

### unstake(amount: U512, dest_purse: Option<URef>)

Burns stCSPR tokens and returns CSPR.

| Parameter | Type | Description |
|-----------|------|-------------|
| `amount` | U512 | Amount in motes to unstake |
| `dest_purse` | Option<URef> | User's purse for real transfer (optional) |

**Behavior:**
- If `dest_purse` is `Some(purse)`: Real CSPR transferred from contract to user
- If `dest_purse` is `None`: Demo mode (internal tracking only)

### get_contract_balance() -> U512

Returns the real CSPR balance held in the contract purse.

---

## Error Codes

| Code | Description |
|------|-------------|
| 100 | Insufficient staked amount |
| 101 | Insufficient stCSPR balance |
| 102 | Insufficient stCSPR for transfer |
| 200 | Not authorized (admin only) |
| 201 | No validators available |
| 203 | Insufficient validator stake |
| 204 | Validator already exists |
| 205 | Max validators reached |
| 206 | Validator not found |
| 210 | Arithmetic overflow |
| 211 | Arithmetic underflow |
| **220** | **Stake transfer failed** |
| **221** | **Unstake transfer failed** |
| **222** | **Failed to get contract balance** |

---

## Deployment Instructions

### Prerequisites

1. Rust toolchain with `wasm32-unknown-unknown` target
2. `casper-client` CLI installed
3. Testnet account with CSPR for gas

### Build Contract

```bash
cd smart-contract

# Install wasm target if needed
rustup target add wasm32-unknown-unknown

# Build the contract
cargo build --release --target wasm32-unknown-unknown

# Contract will be at:
# target/wasm32-unknown-unknown/release/stakevue_contract.wasm
```

### Deploy to Testnet

```bash
# Set your secret key path
SECRET_KEY="/path/to/your/secret_key.pem"

# Deploy the contract
casper-client put-deploy \
    --node-address https://rpc.testnet.casperlabs.io/rpc \
    --chain-name casper-test \
    --secret-key $SECRET_KEY \
    --payment-amount 200000000000 \
    --session-path target/wasm32-unknown-unknown/release/stakevue_contract.wasm
```

### Get Contract Hash

After deployment, query your account to get the contract hash:

```bash
casper-client get-account-info \
    --node-address https://rpc.testnet.casperlabs.io/rpc \
    --public-key $PUBLIC_KEY
```

Look for `stakevue_contract` in the named keys.

### Update Frontend Config

Update `client/public/config.js`:

```javascript
window.config = {
  contract_hash: "hash-YOUR_NEW_CONTRACT_HASH_HERE",
  use_real_transfers: true,
  // ... other config
};
```

---

## Frontend Integration

The frontend already supports V6.1 via:

### Files Modified

| File | Purpose |
|------|---------|
| `transaction.ts` | Builds transactions with `source_purse`/`dest_purse` |
| `useStaking.ts` | Fetches user's purse via CSPR.cloud API |
| `csprCloud.ts` | API service to get `main_purse_uref` |
| `config.js` | Toggle `use_real_transfers` flag |

### Flow

1. User clicks "Stake"
2. Frontend fetches user's `main_purse_uref` from CSPR.cloud
3. Transaction built with `source_purse` parameter
4. User signs transaction
5. Contract transfers CSPR from user's purse to contract purse
6. stCSPR tokens minted

---

## Testing

### Test Stake with Real Transfer

1. Set `use_real_transfers: true` in config.js
2. Connect wallet
3. Stake some CSPR
4. Check that your wallet balance decreased
5. Check contract balance via `get_contract_balance()`

### Test Unstake with Real Transfer

1. Have some staked CSPR
2. Unstake
3. Check that your wallet balance increased
4. Check contract balance decreased

---

## Backward Compatibility

The contract is **fully backward compatible**:

- If `source_purse`/`dest_purse` is `None`, it works like V5.0 (demo mode)
- Existing V5.0 transactions will still work
- Frontend can toggle between modes via `use_real_transfers` config

---

## Security Notes

1. **Purse Access**: User signs the transaction, granting contract temporary access to their purse
2. **Contract Purse**: Only the contract can transfer from its own purse
3. **No Direct Access**: Contract cannot access user purses without explicit parameter

---

**Version:** 6.1.0
**Date:** December 2025
**Status:** Ready for deployment
